pipeline {
    agent any

    environment {
        // SonarQube server name configured in Jenkins
        SONARQUBE_SERVER = 'sonarqube-server'
        // Docker Hub credentials ID from Jenkins credentials
        DOCKERHUB_CREDENTIALS = 'JENKINS1'
        // Docker Hub username
        DOCKERHUB_USER = 'nithinsibi'
        // Docker image name
        IMAGE_NAME = 'springboot-app'
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/nithinsibi-vairumuthu/my-maven-sonar-argocd-helm-k8s.git'
            }
        }

        stage('Maven Build') {
            steps {
              dir('spring-boot-app') { 
                sh 'mvn clean package -DskipTests'
            }
        }
}

       stage('SonarQube Analysis') {
          steps {
            dir('spring-boot-app') {
               withSonarQubeEnv("${SONARQUBE_SERVER}") {
                sh 'mvn sonar:sonar'
            }
        }
    }
}

        stage('Build Docker Image') {
            steps {
                script {
                    sh """
                    docker build -t ${DOCKERHUB_USER}/${IMAGE_NAME}:${BUILD_NUMBER} .
                    """
                }
            }
        }

        stage('Trivy Scan') {
            steps {
                sh """
                trivy image ${DOCKERHUB_USER}/${IMAGE_NAME}:${BUILD_NUMBER} > trivy-report.txt || true
                echo "Trivy scan complete. See trivy-report.txt for results."
                """
            }
        }

        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: "${DOCKERHUB_CREDENTIALS}", usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    sh """
                    echo "$PASS" | docker login -u "$USER" --password-stdin
                    docker push ${DOCKERHUB_USER}/${IMAGE_NAME}:${BUILD_NUMBER}
                    docker logout
                    """
                }
            }
        }
    }

    post {
        success {
            echo '✅ Build and Push Successful!'
        }
        failure {
            echo '❌ Build Failed!'
        }
    }
}
