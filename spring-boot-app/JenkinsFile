pipeline {
    agent any

    environment {
        SONARQUBE_SERVER = 'sonarqube-server'
        DOCKERHUB_CREDENTIALS = 'JENKINS1'
        DOCKERHUB_USER = 'nithinsibi'
        IMAGE_NAME = 'springboot-app'
    }

    stages {

        stage('Checkout Code') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/nithinsibi-vairumuthu/my-maven-sonar-argocd-helm-k8s.git'
            }
        }

        stage('Maven Build') {
            steps {
                dir('spring-boot-app') {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                dir('spring-boot-app') {
                    withSonarQubeEnv("${SONARQUBE_SERVER}") {
                        sh 'mvn sonar:sonar'
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir("${WORKSPACE}/spring-boot-app") {
                    sh """
                    docker build -t ${DOCKERHUB_USER}/${IMAGE_NAME}:${BUILD_NUMBER} .
                    """
                }
            }
        }

        stage('Trivy Scan') {
            steps {
                sh """
                trivy image ${DOCKERHUB_USER}/${IMAGE_NAME}:${BUILD_NUMBER} > trivy-report.txt || true
                echo "Trivy scan complete. See trivy-report.txt for results."
                """
            }
        }

        stage('Push Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: "${DOCKERHUB_CREDENTIALS}", usernameVariable: 'USER', passwordVariable: 'PASS')]) {
                    sh """
                    echo "$PASS" | docker login -u "$USER" --password-stdin
                    docker push ${DOCKERHUB_USER}/${IMAGE_NAME}:${BUILD_NUMBER}
                    docker logout
                    """
                }
            }
        }

        stage('GitOps Update Manifests') {
            steps {
                withCredentials([string(credentialsId: 'git-cred', variable: 'GITHUB_TOKEN')]) {
                    sh '''
                    rm -rf spring-boot-app-manifests
                    git clone https://${GITHUB_TOKEN}@github.com/nithinsibi-vairumuthu/my-maven-sonar-argocd-helm-k8s.git
                    cd spring-boot-app-manifests

                    # Update deployment image
                    sed -i "s|image: .*|image: ${DOCKERHUB_USER}/${IMAGE_NAME}:${BUILD_NUMBER}|g" deployment.yml

                    # Use your GitHub user info
                    git config user.email "nithinsibi@gmail.com"
                    git config user.name "nithin-vairamuthu"

                    git add deployment.yml
                    git commit -m "Updated image tag to ${BUILD_NUMBER}"
                    git push https://nithinsibi-vairumuthu:${GITHUB_TOKEN}@github.com/nithinsibi-vairumuthu/spring-boot-app-manifests.git main
                    '''
                }
            }
        }
    }

    post {
        success {
            echo '✅ Build and Push Successful!'
        }
        failure {
            echo '❌ Build Failed!'
        }
    }
}
